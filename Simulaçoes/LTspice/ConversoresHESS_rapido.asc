Version 4
SHEET 1 2248 924
WIRE -1440 -64 -1536 -64
WIRE -1264 -64 -1440 -64
WIRE -1072 -64 -1136 -64
WIRE -880 -64 -960 -64
WIRE 1248 -64 1184 -64
WIRE 768 -48 688 -48
WIRE -1264 -32 -1296 -32
WIRE -960 -32 -960 -64
WIRE -240 -32 -448 -32
WIRE 32 -32 -160 -32
WIRE 256 -32 32 -32
WIRE 304 -32 256 -32
WIRE 416 -32 304 -32
WIRE 544 -32 416 -32
WIRE 688 -32 688 -48
WIRE 1184 -32 1184 -64
WIRE -448 -16 -448 -32
WIRE -1536 16 -1536 -64
WIRE 256 16 256 -32
WIRE 304 16 304 -32
WIRE 416 16 416 -32
WIRE 544 16 544 -32
WIRE -1584 32 -1616 32
WIRE 32 32 32 -32
WIRE -1296 48 -1296 -32
WIRE -1248 48 -1296 48
WIRE 464 48 448 48
WIRE 688 64 688 48
WIRE -1824 80 -1904 80
WIRE -1648 80 -1696 80
WIRE -1616 80 -1648 80
WIRE -1584 80 -1616 80
WIRE -960 80 -960 48
WIRE -448 80 -448 64
WIRE 1184 80 1184 48
WIRE -1824 112 -1856 112
WIRE -1536 112 -1536 96
WIRE 256 112 256 80
WIRE 304 112 304 80
WIRE 304 112 256 112
WIRE 416 128 416 96
WIRE 544 128 544 96
WIRE 544 128 416 128
WIRE 304 160 304 112
WIRE 416 160 416 128
WIRE 768 160 768 -48
WIRE 816 160 768 160
WIRE 1056 160 1008 160
WIRE -208 176 -368 176
WIRE 32 176 32 112
WIRE 32 176 -128 176
WIRE -1856 192 -1856 112
WIRE -1808 192 -1856 192
WIRE -1264 192 -1360 192
WIRE -1072 192 -1136 192
WIRE -896 192 -960 192
WIRE 816 192 688 192
WIRE 1056 192 1008 192
WIRE -448 208 -448 160
WIRE -1904 224 -1904 80
WIRE -1264 224 -1296 224
WIRE -960 224 -960 192
WIRE 816 224 320 224
WIRE 1056 224 1008 224
WIRE -1360 240 -1360 192
WIRE -368 240 -368 176
WIRE 320 240 320 224
WIRE 688 240 688 192
WIRE -1440 256 -1440 -64
WIRE -1408 256 -1440 256
WIRE -1616 304 -1616 80
WIRE -1408 304 -1616 304
WIRE -1296 304 -1296 224
WIRE -1248 304 -1296 304
WIRE -1904 336 -1904 304
WIRE -1360 336 -1360 320
WIRE -960 336 -960 304
WIRE -368 336 -368 304
WIRE 32 336 32 176
WIRE 320 336 320 320
WIRE 688 336 688 320
FLAG -448 208 0
FLAG 304 160 0
FLAG 416 160 0
FLAG -448 -32 Vbt
FLAG 1056 192 I1
IOPIN 1056 192 Out
FLAG 688 336 0
FLAG -1248 48 I1
IOPIN -1248 48 In
FLAG 688 192 Ibt
FLAG 1056 224 I2
IOPIN 1056 224 Out
FLAG 320 336 0
FLAG 1056 160 Vd
IOPIN 1056 160 Out
FLAG 320 224 Isc
FLAG 416 -32 Vbus
FLAG -1904 336 0
FLAG -1904 80 ref
FLAG -1808 192 Vd
IOPIN -1808 192 In
FLAG -1248 304 I2
IOPIN -1248 304 In
FLAG -1616 32 0
FLAG -1536 112 0
FLAG -1360 336 0
FLAG -1072 192 erroSC
FLAG -368 336 0
FLAG -368 176 Vsc
FLAG -1072 -64 ErroBT
FLAG -960 336 0
FLAG -960 80 0
FLAG -880 -64 Dbt
FLAG -896 192 Dsc
FLAG 32 336 0
FLAG 688 64 0
FLAG 1184 80 0
FLAG 1248 -64 DesgasteBateria
FLAG 464 48 w
FLAG -448 80 e
FLAG -1648 80 Iref
SYMBOL voltage -448 64 R0
WINDOW 3 32 76 Left 2
WINDOW 123 0 0 Left 2
WINDOW 39 0 0 Left 0
SYMATTR Value 7.2
SYMATTR InstName V1
SYMBOL cap 288 16 R0
SYMATTR InstName C1
SYMATTR Value 680µ
SYMATTR SpiceLine V=100 Rser=15m Lser=500p Rpar=12Meg
SYMBOL cap 240 16 R0
SYMATTR InstName C3
SYMATTR Value 1µ
SYMBOL bv 688 224 R0
SYMATTR InstName B6
SYMATTR Value V=I(B1)+.1*(rand(time*1e6)-.5)
SYMBOL carga_motor 384 16 R0
SYMATTR InstName X1
SYMBOL res 528 0 R0
SYMATTR InstName R1
SYMATTR Value 10k
SYMBOL controladorPI -1200 -48 R0
WINDOW 39 0 -23 Bottom 2
SYMATTR SpiceLine P=.42 I=1100 max=5 min=0
SYMATTR InstName X2
SYMBOL bv 320 224 R0
SYMATTR InstName B7
SYMATTR Value V=I(B2)+.1*(rand(time*1e6)-.5)
SYMBOL frontend_analog 912 160 R0
SYMATTR InstName X3
SYMBOL controladorPI -1200 208 R0
WINDOW 39 0 -23 Bottom 2
SYMATTR SpiceLine P=.4 I=1000 max=20 min=-20
SYMATTR InstName X4
SYMBOL controladorPI -1760 96 R0
WINDOW 39 0 -23 Bottom 2
SYMATTR SpiceLine P=1.6 I=1200
SYMATTR InstName X5
SYMBOL cap -384 240 R0
WINDOW 0 -32 17 Left 2
WINDOW 3 -21 56 Left 2
SYMATTR InstName C2
SYMATTR Value 66
SYMATTR SpiceLine Irms=80 Rser=20m
SYMBOL e2 -1360 224 R0
WINDOW 3 24 96 Invisible 2
SYMATTR Value 1
SYMATTR InstName E2
SYMBOL bi -240 -32 R270
WINDOW 0 32 40 VTop 2
WINDOW 3 -32 40 VBottom 2
WINDOW 123 -89 37 VTop 2
SYMATTR InstName B1
SYMATTR Value I= (V(Dbt)*V(Vbt) - V(Vbus))
SYMATTR Value2 Laplace= 1/(200u*s+50m)
SYMBOL bv -960 -48 R0
SYMATTR InstName B4
SYMATTR Value V= limit(0, V(erroBT), 2)
SYMBOL bi -208 176 R270
WINDOW 0 32 40 VTop 2
WINDOW 3 -32 40 VBottom 2
WINDOW 123 -89 37 VTop 2
SYMATTR InstName B2
SYMATTR Value I= ( V(Vsc) - V(Dsc)*V(Vbus) )*u(time)
SYMATTR Value2 Laplace= 1/(120u*s+50m)
SYMBOL bi2 32 32 R0
SYMATTR InstName B3
SYMATTR Value I= V(Dsc)*I(B2)
SYMBOL bv 688 -48 R0
SYMATTR InstName B8
SYMATTR Value V=V(Vbus)+.1*(rand(time*1e5)-.5)
SYMBOL voltage -1904 208 R0
WINDOW 123 0 0 Left 0
WINDOW 39 24 124 Left 2
WINDOW 3 10 104 Left 2
SYMATTR Value PULSE(0 7 0 1m 1m 60 65 1)
SYMATTR InstName V2
SYMBOL e2 -1536 0 R0
WINDOW 3 15 93 Left 2
SYMATTR Value Laplace=1/(tau*s+1)
SYMATTR InstName E1
SYMBOL res -464 -32 R0
SYMATTR InstName R2
SYMATTR Value 200m
SYMBOL bv 1184 -48 R0
SYMATTR InstName B9
SYMATTR Value V= idt( V(Vbt,e)*I(R2) )
SYMBOL bv -960 208 R0
SYMATTR InstName B5
SYMATTR Value V= 1/pow( max( V(erroSC), 1 ), 2 )
TEXT 1168 216 Left 2 !.tran 0 65 4.4m startup
TEXT 56 200 Left 2 !.ic V(Vsc)=6\n.ic V(Vbus)=0
TEXT 1168 128 Left 2 !.options reltol=1e-2\n.options gmin 1e-10\n.options maxstep=26u
TEXT -1736 -48 Left 2 !.param tau=14
TEXT 568 -136 Left 2 ;.save V(Vbus) V(Vsc) V(Iref) V(desgastebateria)\n.save V(w) I(B1) I(B2) Ix(x1) dialogbox
